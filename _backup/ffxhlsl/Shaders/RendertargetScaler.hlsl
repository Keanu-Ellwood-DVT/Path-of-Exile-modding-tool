//PRECOMPILE vs_4_0 VShad
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_COLOR 1 COPY 1 MIXED_FILTER 1
//PRECOMPILE ps_4_0 Resample OUT_DEPTH 1 COPY 1 MIXED_FILTER 1
//PRECOMPILE vs_gnm VShad
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 AVG_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 AVG_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MAX_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MAX_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 NEAREST_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 NEAREST_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MIXED_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 UPSAMPLE 1 MIXED_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 AVG_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 AVG_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MAX_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MAX_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 NEAREST_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 NEAREST_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MIXED_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MIXED_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MINMAX_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 DOWNSAMPLE 1 MINMAX_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 AVG_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 AVG_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MAX_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MAX_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 NEAREST_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 NEAREST_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MIXED_FILTER 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MIXED_FILTER 1 DST_FP32_R 1
//PRECOMPILE ps_gnm Resample OUT_COLOR 1 COPY 1 MIXED_FILTER 1 DST_FP32_GR 1
//PRECOMPILE ps_gnm Resample OUT_DEPTH 1 COPY 1 MIXED_FILTER 1
//PRECOMPILE vs_vkn VShad
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 UPSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 UPSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 UPSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 UPSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 DOWNSAMPLE 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 DOWNSAMPLE 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 DOWNSAMPLE 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 DOWNSAMPLE 1 MIXED_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 DOWNSAMPLE 1 MINMAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 COPY 1 AVG_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 COPY 1 MAX_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 COPY 1 NEAREST_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_COLOR 1 COPY 1 MIXED_FILTER 1
//PRECOMPILE ps_vkn Resample OUT_DEPTH 1 COPY 1 MIXED_FILTER 1

#ifdef DST_FP32_R
	#pragma PSSL_target_output_format (target 0 FMT_32_R)
#endif
#ifdef DST_FP32_GR
	#pragma PSSL_target_output_format (target 0 FMT_32_GR)
#endif

#ifdef MULTISAMPLING
	TEXTURE2DMS_DECL( tex_sampler, SAMPLE_COUNT );
#else
	TEXTURE2D_DECL( tex_sampler );
#endif

CBUFFER_BEGIN( cdynamic_resolution_scale )
	float4 dynamic_resolution_scale;
	float4 src_size;
	float4 dst_size;
	float4 gamma_vec;
	float src_mip_level;
CBUFFER_END

struct VOut
{
	float4 pos : SV_POSITION;
};

VOut VShad( float4 position : POSITION )
{
	VOut output;
	output.pos = position;
	return output;
}

#define SUBPIXEL_READ

float4 ReadSrcPixel(float2 src_pixel, float2 src_size)
{
	float2 unorm_uv = (src_pixel + float2(0.5f, 0.5f));
	float4 res = 0.0f;
	#ifdef MULTISAMPLING
		#if defined(SUBPIXEL_READ) && !defined(NEAREST_FILTER)
			#ifdef MAX_FILTER
				res = -1e7f;
				for (int i = 0; i < SAMPLE_COUNT; ++i)
				{
					res = max(res, tex_sampler.Load(unorm_uv, i));
				}
			#endif
			#if defined(AVG_FILTER) || defined(MIXED_FILTER)
				res = 0.0f;
				for (int i = 0; i < SAMPLE_COUNT; ++i)
				{
					res += tex_sampler.Load(unorm_uv, i) * (1.0f / float(SAMPLE_COUNT));
				}
			#endif
		#else
			res = tex_sampler.Load(unorm_uv, 0);
		#endif
	#else
		float2 norm_uv = unorm_uv / src_size;
		res = SAMPLE_TEX2DLOD( tex_sampler, SamplerLinearClamp, float4(norm_uv.xy, 0.0f, src_mip_level) );
	#endif
	return res;
}

float4 Downsample(VOut vertex_input)
{
	float2 base_dst_pixel = (vertex_input.pos.xy - float2(0.5, 0.5));

	float4 max_value = -1e7f;
	float4 min_value = 1e7f;
	float4 avg_value = 0.0f;
	float4 nearest_value = 0.0f;
	float4 mixed_value = 0.0f;

	float2 scale = floor(src_size.xy * dynamic_resolution_scale.xy / dst_size.xy + float2(0.5f, 0.5f));
	float2 base_src_pixel = base_dst_pixel * scale;
	//float4 gamma_vec = 1.0f;
	#ifdef NEAREST_FILTER
		nearest_value = ReadSrcPixel(base_src_pixel, src_size.xy);
	#else
		float mult = 1.0f / (floor(scale.x + 0.5f) * floor(scale.y + 0.5f) + 1e-5f);
		float4 first_value = ReadSrcPixel(base_src_pixel + float2(0, 0), src_size.xy);

		for(float y = 0.0f; y < scale.x - 0.5f; y += 1.0f)
		{
			for(float x = 0.0f; x < scale.y - 0.5f; x += 1.0f)
			{
				float4 src_sample = ReadSrcPixel(base_src_pixel + float2(x, y), src_size.xy);
				max_value = max(max_value, src_sample);
				min_value = min(min_value, src_sample);
				avg_value += src_sample * mult;
				mixed_value += pow(max(0, src_sample), gamma_vec.x) * mult;
			}
		}

	#endif

	#ifdef MAX_FILTER
		return max_value;
	#endif
	#ifdef MINMAX_FILTER
		//return max_value;
		return first_value;
		float even = float(uint(base_dst_pixel.x + base_dst_pixel.y) % 2);
		//return even;
		float4 minmax = even * min_value + (1.0f - even) * max_value;
		return minmax;
	#endif
	#ifdef NEAREST_FILTER
		return nearest_value;
	#endif
	#ifdef AVG_FILTER
		return avg_value;
	#endif
	#ifdef MIXED_FILTER
		return pow(max(0, mixed_value), 1.0f / gamma_vec.x)/* * mult_vec.x*/;
		//return mixed_value;
	#endif

	return float4(0.0f, 0.0f, 1.0f, 1.0f);
}

float4 Upsample(VOut vertex_input)
{
	#define UPSAMPLING_OFFSET 0.5 //0.5 offset produces slight offset, but makes the image more crisp. 0.0 positions upsampled image exactly but introduces blur

	float2 base_dst_pixel = vertex_input.pos.xy - float2(0.5f, 0.5f); //supersampled
	float2 scale = floor(dst_size.xy * dynamic_resolution_scale.xy / src_size.xy + float2(0.5f, 0.5f));

	float2 base_src_pixel = (base_dst_pixel - float2(0.5f, 0.5f) + UPSAMPLING_OFFSET) / scale;
	return ReadSrcPixel(base_src_pixel, src_size.xy);
}

float4 Copy(VOut vertex_input)
{
	float2 dst_pixel = vertex_input.pos.xy - float2(0.5f, 0.5f); //supersampled
	float2 src_pixel = dst_pixel;
	return ReadSrcPixel(src_pixel, src_size.xy);
}

float4 Resample(VOut vertex_input, out float out_depth : SV_DEPTH) : PIXEL_RETURN_SEMANTIC
{
	float4 res;

	#ifdef COPY
		res = Copy(vertex_input);
	#endif

	#ifdef DOWNSAMPLE
		res = Downsample(vertex_input);
	#endif

	#ifdef UPSAMPLE
		res = Upsample(vertex_input);
	#endif

	#ifdef OUT_DEPTH
		out_depth = res;
		return float4(0.0f, 0.0f, 0.0f, 0.0f);
	#else //OUT_COLOR
		out_depth = 0.0f;
		return res;
	#endif
}
